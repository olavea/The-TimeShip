<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>The TimeShip</title>
        <script type="text/javascript" src="https://sdk.userbase.com/1/userbase.js"></script>
        <script src="https://js.stripe.com/v3/"></script>
      </head>
      <body>
        <!-- Auth View -->
        <div id="auth-view">
          <h1>Login To The TimeShip</h1>
          <form id="login-form">
              <input id="login-username" type="text" required placeholder="Username">
              <input id="login-password" type="password" required placeholder="pasSword">
              <input type="submit" value="Sign in">
          </form>
          <div id="login-error"></div>


          <h1>Sign Up For The TimeShip</h1>
          <form id="signup-form">
            <input id="signup-username" type="text" required placeholder="Username">
            <input id="signup-password" type="password" required placeholder="pasSword">
            <input type="submit" value="Create an account">
          </form>
          <div id="signup-error"></div>
        </div>
        <!-- Add A Go-Year View needs some work-->
        <div id="todo-view">
          <div id="username"></div>
          <input type="button" value="Logout" id="logout-button">
          <div id="logout-error"></div>

          <h1>Add A Go-Year</h1>
          <div id="goyear"></div>
          <div id="db-loading">Loading Go-Year...</div>
          <div id="db-error"></div>

          <form id="add-goyear-form">
            <input id="add-year" type="text" required placeholder="Year">
            <!-- <input id="add-email" type="email" required placeholder="Year"> -->
            <input type="submit" value="Add">
          </form>
          <div id="add-goyear-error"></div>

      </div>
      <!-- application code -->
        <!-- Is signUp a function from userbase? Yes-->
        <script type="text/javascript">
          userbase.init({ appId: '8af6f24a-fcf3-4fa5-9e20-c8fe279c5b5c' })

          function handleTimeShipLogin(e) {
                e.preventDefault()

                const username = document.getElementById('login-username').value
                const password = document.getElementById('login-password').value

                userbase.signIn({ username, password, rememberMe: 'none' })
                .then((user) => showTimeShipGoYear(user.username))
                .catch((e) => document.getElementById('login-error').innerHTML = e)
          }

          function handleTimeShipSignUp(event) {
              event.preventDefault()
              const username = document.getElementById('signup-username').value
              const password = document.getElementById('signup-password').value

              userbase.signUp({ username, password, rememberMe: 'none' })
              .then((user) => showTimeShipGoYear(user.username))
              .catch((event) => document.getElementById('signup-error').innerHTML = event)

          }
          function handleTimeShipLogout(e) {
                userbase.signOut()
                .then(() => showAuth())
                .catch((e) => document.getElementById('logout-error').innerText = e)
          }

          function showTimeShipGoYear(user) {
                const successUrl = 'http://localhost:8000/solhauggata'
                const cancelUrl = 'http://localhost:8008/londonbridge'

                if (!user.subscriptionStatus) {
                    userbase.purchaseSubscription({ successUrl, cancelUrl })
                    return
                }
                document.getElementById('auth-view').style.display = 'none'
                document.getElementById('todo-view').style.display = 'block'

                // reset the Add A Go-Year view
                document.getElementById('username').innerHTML = username
                document.getElementById('goyear').innerText = ''
                document.getElementById('db-loading').style.display = 'block'
                document.getElementById('db-error').innerText = ''

                userbase.openDatabase({ databaseName: 'goyear', changeHandler })
                  .catch((e) => document.getElementById('db-error'). innerText = e)


          }
          function changeHandler(items) {
              document.getElementById('db-loading').style.display = 'none'

              const goyearthing = document.getElementById('goyear')

              if (items.length === 0) {
                goyearthing.innerText = 'Empty'
              } else {
                  // clear the thing
                  goyearthing.innerHTML = ''

                  // render the go-year, do I meed this? I only have ONE item.
                  for (let i = 0; i < items.length; i++) {

                    // build the goyear label
                    const goyearLabel = document.createElement('label')
                    goyearLabel.innerHTML = items[i].item.todo
                    goyearLabel.style.textDecoration = items[i].item.complete ? 'line-through' : 'none'

                    // append the todo item to the list
                    const goyearItem = document.createElement('div')
                    goyearItem.appendChild(goyearLabel)
                    goyearthing.appendChild(goyearItem)
                  }
              }
          }

          function addTodoHandler(e) {
            e.preventDefault()

            const goyear = document.getElementById('add-year').value

            userbase.insertItem({ databaseName: 'goyear', item: { 'goyear': goyear }})
              .then(() => document.getElementById('add-year').value = '')
              .catch((e) => document.getElementById('add-goyear-error').innerHTML = e)
          }

          document.getElementById('login-form').addEventListener('submit', handleTimeShipLogin)
          document.getElementById('signup-form').addEventListener('submit', handleTimeShipSignUp)
          document.getElementById('add-goyear-form').addEventListener('submit', addTodoHandler)

          document.getElementById('logout-button').addEventListener('click', handleTimeShipLogout)
          document.getElementById('todo-view').style.display = 'none'
        </script>
      </body>
      </html>
<!--
I stopped before
Updating to-dos
        -->
